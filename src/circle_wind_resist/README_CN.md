# MAVROS Offboard 圆形轨迹控制 (抗风版)

本 ROS 节点通过 MAVROS 功能包实现 PX4 飞控的抗风圆形航线飞行。与基础圆形轨迹不同，此版本使用速度前馈控制以在风力条件下保持轨迹精度。

[ENGLISH](README.md)

## 功能描述

* **速度前馈**：使用 `PositionTarget` 消息同时发布位置和速度设定点，提高轨迹跟踪性能。
* **基于时间生成**：根据经过的时间实时计算轨迹设定点，而非预先计算的航点。
* **自动介入**：建立连接后，自动尝试将飞控切换至 `OFFBOARD` 模式并执行 `ARM`(解锁)操作。
* **增强控制**：使用 `mavros/setpoint_raw/local` 话题同时发送位置和速度指令。
* **持续飞行**：无限圆形轨迹，自动追踪循环完成情况。

## 实现思路

### 1. 实时轨迹生成
使用参数方程动态计算位置和速度:

**位置:**
$$x = x_c + R \cdot \cos(\omega t)$$
$$y = y_c + R \cdot \sin(\omega t)$$
$$z = h$$

**速度 (位置的导数):**
$$v_x = -R \omega \cdot \sin(\omega t)$$
$$v_y = R \omega \cdot \cos(\omega t)$$
$$v_z = 0$$

**偏航角 (切线方向):**
$$\psi = \omega t + \frac{\pi}{2}$$

其中:
- $R=2.0m$ (半径)
- $\omega=0.3 \text{ rad/s}$ (角速度)
- $h=2.0m$ (高度)

### 2. 为什么使用速度前馈?
在有风条件下，纯位置控制会表现出滞后，因为控制器必须先检测到位置误差才能做出反应。通过提供预期速度，飞控可以:
- 预测所需的推力调整
- 减少跟踪误差和过冲
- 保持更平滑的轨迹执行

### 3. 安全握手 (Safety Handshake)
PX4 飞控要求在切换到 Offboard 模式**之前**接收到设定点流。脚本预先发送 100 个初始设定点以满足此要求。

### 4. 状态机与控制环
主循环(20Hz):
1. **状态监控**：如需要，每隔 5 秒尝试一次模式切换和解锁。
2. **轨迹更新**：根据经过时间计算当前位置和速度。
3. **指令发布**：发送包含位置和速度字段的 `PositionTarget` 消息。

## 依赖项
* **ROS 1** (推荐 Noetic)
* **MAVROS** (需包含 `mavros_msgs` 和 `geometry_msgs`)
* **Python 库**: `rospy`, `math`

## 关键参数
| 参数      | 值   | 说明               |
| :-------- | :--- | :----------------- |
| `R`       | 2.0  | 圆半径 (米)        |
| `HEIGHT`  | 2.0  | 飞行高度 (米)      |
| `OMEGA`   | 0.3  | 角速度 (rad/s)     |
| `RATE_HZ` | 20.0 | 控制频率           |

## 使用方法

运行控制节点：

```bash
chmod +x circle_wind_resist.py
roslaunch launch/circle_wind_resist.launch
```

## 与基础版本对比

| 特性         | 基础版本                 | 抗风版本                       |
| :----------- | :----------------------- | :----------------------------- |
| **设定点类型** | 仅位置                   | 位置 + 速度                    |
| **话题**     | `setpoint_position/local` | `setpoint_raw/local`           |
| **消息类型** | `PoseStamped`            | `PositionTarget`               |
| **轨迹逻辑** | 基于航点                 | 基于时间连续                   |
| **抗风性能** | 有一定滞后               | 滞后减少，跟踪性能更好         |
