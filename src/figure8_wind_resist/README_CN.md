# MAVROS Offboard 8字形轨迹控制 (抗风版)

本 ROS 节点通过 MAVROS 功能包实现 PX4 飞控的抗风8字形(∞符号)航线飞行。与基于航点的基础版本不同，此实现使用实时速度前馈控制，在风力条件下具有更优的跟踪精度。

[ENGLISH](README.md)

## 功能描述

* **速度前馈**：使用 `PositionTarget` 消息同时发布位置和速度设定点，提高轨迹跟踪性能。
* **基于时间生成**：使用李萨如曲线数学公式，根据经过的时间实时计算轨迹设定点。
* **自动介入**：建立连接后，自动尝试将飞控切换至 `OFFBOARD` 模式并执行 `ARM`(解锁)操作。
* **增强控制**：使用 `mavros/setpoint_raw/local` 话题同时发送位置和速度指令。
* **动态偏航**：持续更新偏航角以与速度方向对齐(曲线切线)。
* **持续飞行**：无限8字形轨迹，自动追踪循环完成情况。

## 实现思路

### 1. 实时轨迹生成
使用李萨如曲线方程动态计算位置和速度:

**位置:**
$$x = x_c + A_x \cdot \sin(\omega t)$$
$$y = y_c + \frac{A_y}{2} \cdot \sin(2\omega t)$$
$$z = h$$

**速度 (位置的导数):**
$$v_x = A_x \omega \cdot \cos(\omega t)$$
$$v_y = A_y \omega \cdot \cos(2\omega t)$$
$$v_z = 0$$

**偏航角 (切线方向):**
$$\psi = \text{atan2}(v_y, v_x)$$

其中:
- $A_x=2.0m$ (X轴振幅)
- $A_y=1.0m$ (Y轴振幅)
- $\omega=0.3 \text{ rad/s}$ (角速度)
- $h=2.5m$ (高度)
- 频率比 1:2 形成8字形状

### 2. 为什么使用速度前馈?
在有风条件下，纯位置控制会表现出滞后，因为控制器必须先检测到位置误差才能做出反应。通过提供预期速度:
- 飞控可以预测所需的推力调整
- 减少跟踪误差和过冲
- 即使有风扰，8字形状仍保持精确

### 3. 安全握手 (Safety Handshake)
PX4 飞控要求在切换到 Offboard 模式**之前**接收到设定点流。脚本预先发送 100 个初始设定点以满足此要求。

### 4. 状态机与控制环
主循环(20Hz):
1. **状态监控**：如需要，每隔 5 秒尝试一次模式切换和解锁。
2. **轨迹更新**：根据经过时间计算当前位置和速度。
3. **指令发布**：发送包含位置、速度和偏航角字段的 `PositionTarget` 消息。

## 依赖项
* **ROS 1** (推荐 Noetic)
* **MAVROS** (需包含 `mavros_msgs` 和 `geometry_msgs`)
* **Python 库**: `rospy`, `math`

## 关键参数
| 参数          | 值   | 说明               |
| :------------ | :--- | :----------------- |
| `AMPLITUDE_X` | 2.0  | X方向振幅 (米)     |
| `AMPLITUDE_Y` | 1.0  | Y方向振幅 (米)     |
| `HEIGHT`      | 2.5  | 飞行高度 (米)      |
| `OMEGA`       | 0.3  | 角速度 (rad/s)     |
| `RATE_HZ`     | 20.0 | 控制频率           |

## 使用方法

运行控制节点：

```bash
chmod +x figure8_wind_resist.py
roslaunch launch/figure8_wind_resist.launch
```

## 与基础版本对比

| 特性         | 基础版本                 | 抗风版本                       |
| :----------- | :----------------------- | :----------------------------- |
| **设定点类型** | 仅位置                   | 位置 + 速度                    |
| **话题**     | `setpoint_position/local` | `setpoint_raw/local`           |
| **消息类型** | `PoseStamped`            | `PositionTarget`               |
| **轨迹逻辑** | 基于航点 (100点)         | 基于时间连续                   |
| **偏航控制** | 未指定                   | 动态(跟随速度)                 |
| **抗风性能** | 有一定滞后               | 滞后减少，跟踪性能更好         |
